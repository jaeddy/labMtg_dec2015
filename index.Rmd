---
title       : TCR-seq Pipeline Development
subtitle    : Getting to know MiXCR a little better
author      : James Eddy
job         : 
framework   : io2012        # {io2012, html5slides, shower, dzslides, ...}
highlighter : highlight.js  # {highlight.js, prettify, highlight}
hitheme     : tomorrow      # 
widgets     : [d3_sankey]
mode        : selfcontained # {standalone, draft}
knit        : slidify::knit2slides
---
`r opts_chunk$set(echo=FALSE, message=FALSE, comment="")`

<!-- Limit image width and height -->
<style type="text/css">
img {     
  max-height: 500px;     
  max-width: 800px; 
}
</style>
 
<!-- Center image on slide -->
<script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.7.min.js"></script>
<script type="text/javascript">
$(function() {     
  $("p:has(img)").addClass('centered'); 
});
</script>

<!-- Fix markdown emphasis -->
<style>
strong {
  font-weight: bold;
}
</style>

```{r load_libs, cache=FALSE}
library(knitr)
library(readr)
library(reshape2)
library(ggplot2)
library(cowplot)
library(dplyr)
library(stringr)
library(tidyr)
library(rCharts)
```

---  

## From single cells to clonotypes
#### TCR-sequencing at BRI
<br>

![tcrseq](images/tcrseq.png) 

---  

## TCR-seq workflow
#### RNA-seq processing for clonotype identification 
<br>

![imgt_workflow](images/imgt_workflow.png)

---  

## MiXCR for clonotype identification & quantification
#### Avoiding the IMGT bottleneck
<br>

> * Very fast, accurate alignment of reads to CDR3 (and other T-, B-cell 
features)  
> * Runs locally, without need for **Trinity** transcriptome assembly
> * Found, implemented, & tested by Mike Mason
> * Produced very similar results to IMGT V-QUEST in initial testing (later,
we encountered some discrepancies related to input data)

---  

## Plugging in MiXCR
#### Improving pipeline performance & reliability
<br>

![mixcr_workflow](images/mixcr_workflow.png)

---  

## Investigating discrepancies with MiXCR
#### Variation in MiXCR output & overlap with IMGT
<br>

> * Looking at MiXCR results from different projects, Peter observed dropoff
in number of functional junctions identified
> * By extension, more recent projects also showed worse overlap with IMGT
> * Overlap in these cases appears highly dependent on cutoff used for
`clone count` metric
> * For some of the problematic projects, MiXCR was run by me instead of Mike
> * Projects were also processed in Galaxy at different times

---  

## Taking a closer look at P85
#### Exploring MiXCR results with MAIT cells
<br>

![mixcr_diff](images/mixcr_diff.png)

---  
`r opts_knit$set(root.dir = "/Users/jaeddy/code/github/projects/tcrSeqAnalysis/")`

## Working with clonotype data in `R`
#### Combining MiXCR outputs

```{r, echo=TRUE, cache=FALSE}
source("R/prep_junctions.R")
```

```{r, echo=TRUE}
mixcr_folder <- "data/P85/P85_MAIT/mixcrOutput_MM"
project <- "P85"
out_folder <- mixcr_folder

# combine MiXCR junctions into a single file
mixcr_file <- combine_mixcr_outputs(mixcr_folder, out_folder, project)
```

---

## Working with clonotype data in `R`
#### Reading & formatting MiXCR outputs

```{r echo=TRUE}
mixcr <- format_mixcr_jxns(mixcr_file) %>% # read, format junctions
    filter_mixcr_jxns() %>% # remove non-functional, aa length < 7
    list(jxns = .) # store in list object
```

`mixcr$jxns`
```{r}
head(mixcr$jxns, 5) %>% kable()
```

--- 

## Working with clonotype data in `R`
#### Visually inspecting MiXCR junction data
<br>

```{r, cache=FALSE, fig.width=10, fig.height=6}
source("R/plot_junction_stats.R")
p1 <- plot_mixcr_jxn_dist(mixcr$jxns, cutoff_line = 20)
p2 <- plot_mixcr_summary(mixcr$jxns)
plot_grid(p1, p2, nrow = 2)
```

--- 

## Working with clonotype data in `R`
#### Reading & formatting IMGT outputs

```{r echo=TRUE}
imgt_file <- "data/P85/P85_MAIT/complied_P85_Prilic_1_and_2_productive_trimmed_unique.txt"

imgt <- format_imgt_jxns(imgt_file) %>% # read and filter IMGT junctions
    filter_imgt_jxns() %>% # remove non-functional, aa length < 7
    filter(!str_detect(lib_id, "lib2.*")) %>% # remove older samples
    list(jxns = .) # store in list object
```

`imgt$jxns`
```{r}
head(imgt$jxns, 5) %>% kable()
```

--- 

## Working with clonotype data in `R`
#### Inspecting IMGT & MiXCR junction overlap
<br>

```{r, fig.align='center', fig.width=10, fig.height=6}
p1 <- compare_jxn_dists(imgt$jxns, mixcr$jxns) %>% 
    plot_jxn_comp()
p1
```

--- 

## Investigating discrepancies with MiXCR
#### Checking for user variability with P85
<br>

```{r, fig.align='center', fig.width=12, fig.height=6, warning=FALSE}
mixcr_folder <- "data/P85/P85_MAIT/mixcrOutput_JE"
project <- "P85"
out_folder <- mixcr_folder

# Combine MiXCR junctions into a single file; read, format, and filter junctions
mixcr_je <- 
    combine_mixcr_outputs(mixcr_folder, out_folder, project) %>% 
    format_mixcr_jxns() %>% 
    filter_mixcr_jxns() %>% 
    list(jxns = .)

p2 <- compare_jxn_dists(imgt$jxns, mixcr_je$jxns) %>% 
    plot_jxn_comp()
plot_grid(p1, p2, labels = c("Processing & MiXCR execution by Mike",
                             "Processing by Mike, MiXCR execution by James"))
```

--- 

## Investigating discrepancies with MiXCR
#### Checking the effect of RNA-seq parameters
<br>

+ **Read trimming:** adapter trimming, 3' end trimming, quality trimming  
+ **Duplicate removal:** yes or no
+ **Read length:** 100bp (long) vs. 58bp (short)

**Testing:** used RNA-seq data from [INSERT_FLOWCELL_HERE]: 100bp reads

+ selected 20 samples  
+ manually simulated shorter reads for same set of samples  
+ varied other parameters  
+ ran both MiXCR & IMGT (bonus function: `compile_imgt_output()`)  

```{r}
project <- "P85"

# Read and format IMGT outputs

# 1) 100bp reads
summary_file <- "data/P85/P85_100/imgtOutput/1_Summary.txt"
out_folder <- dirname(summary_file)
        
# Compile and format IMGT junctions; read and filter junctions
p85_100_imgt <- 
    compile_imgt_output(summary_file, out_folder, project) %>% 
    format_imgt_jxns() %>% 
    filter_imgt_jxns() %>% 
    list(jxns = .)

# 1) 58bp reads
summary_file <- "data/P85/P85_58/imgtOutput/1_Summary.txt"
out_folder <- dirname(summary_file)
        
# Compile and format IMGT junctions; read and filter junctions
p85_58_imgt <- 
    compile_imgt_output(summary_file, out_folder, project) %>% 
    format_imgt_jxns() %>% 
    filter_imgt_jxns() %>% 
    list(jxns = .)
```

```{r}
# Read and format MiXCR outputs

# 1) 100 bp reads, duplicates removed
mixcr_folder <- "data/P85/P85_100/mixcrOutput_rmDups/"
out_folder <- mixcr_folder

# combine MiXCR junctions into single file; read, format, and filter junctions
p85_100_mixcr <- 
    combine_mixcr_outputs(mixcr_folder, out_folder, project) %>% 
    format_mixcr_jxns() %>% 
    filter_mixcr_jxns() %>% 
    list(jxns = .)

# 2) 58 bp reads, duplicates removed
mixcr_folder <- "data/P85/P85_58/mixcrOutput_rmDups/"
out_folder <- mixcr_folder

# combine MiXCR junctions into single file; read, format, and filter junctions
p85_58_mixcr <- 
    combine_mixcr_outputs(mixcr_folder, out_folder, project) %>% 
    format_mixcr_jxns() %>% 
    filter_mixcr_jxns() %>% 
    list(jxns = .)

# 3) 100 bp reads, keep duplicates
mixcr_folder <- "data/P85/P85_100/mixcrOutput_keepDups/"
out_folder <- mixcr_folder

# combine MiXCR junctions into single file; read, format, and filter junctions
p85_100_mixcr_dups <- 
    combine_mixcr_outputs(mixcr_folder, out_folder, project) %>% 
    format_mixcr_jxns() %>% 
    filter_mixcr_jxns() %>% 
    list(jxns = .)

# 4) 58 bp reads, keep duplicates
mixcr_folder <- "data/P85/P85_58/mixcrOutput_keepDups/"
out_folder <- mixcr_folder

# combine MiXCR junctions into single file; read, format, and filter junctions
p85_58_mixcr_dups <- 
    combine_mixcr_outputs(mixcr_folder, out_folder, project) %>% 
    format_mixcr_jxns() %>% 
    filter_mixcr_jxns() %>% 
    list(jxns = .)
```

--- 

## Investigating discrepancies with MiXCR
#### Checking the effect of RNA-seq parameters
<br>

```{r, fig.align='center', fig.width=12, fig.height=7}
p1 <- compare_jxn_dists(p85_100_imgt$jxns, p85_100_mixcr$jxns) %>% 
    plot_jxn_comp()
p2 <- compare_jxn_dists(p85_100_imgt$jxns, p85_100_mixcr_dups$jxns) %>% 
    plot_jxn_comp()

p3 <- compare_jxn_dists(p85_58_imgt$jxns, p85_58_mixcr$jxns) %>% 
    plot_jxn_comp()
p4 <- compare_jxn_dists(p85_58_imgt$jxns, p85_58_mixcr_dups$jxns) %>% 
    plot_jxn_comp()
plot_grid(p1, p2, p3, p4,
          labels = c("100bp, dups removed",
                     "100bp, keep dups",
                     "58bp, dups removed",
                     "58bp, keep dups"))
```

---

## Case 2: P91

![p91_circos](images/circos.png)

---

## MiXCR (with short reads) vs. IMGT

```{r, cache=FALSE}
project <- "P91-11"

summary_file <- "data/P91/P91_11_1_Summary.txt"
out_folder <- dirname(summary_file)
        
# Compile and format IMGT junctions; read and filter junctions
p91_imgt <- 
    compile_imgt_output(summary_file, out_folder, project) %>% 
    format_imgt_jxns() %>% 
    filter_imgt_jxns() %>% 
    list(jxns = .)

mixcr_folder <- "data/P91_new/P91-11/mixcrOutput_trimFqs/"
project <- "P91-11"
out_folder <- mixcr_folder

# Combine MiXCR junctions into a single file; read, format, and filter junctions
p91_mixcr <- 
    combine_mixcr_outputs(mixcr_folder, out_folder, project) %>% 
    format_mixcr_jxns() %>% 
    filter_mixcr_jxns(min_count = 10) %>% 
    list(jxns = .)
```

```{r, cache=FALSE}
source("R/inspect_tcrs.R")
```

---

## Constructing & inspecting TCRs

```{r echo=TRUE, cache=FALSE}
# Combine TRAV and TRBV junctions to construct TCRs
p91_imgt[["tcrs"]] <- p91_imgt$jxns %>% 
    construct_tcrs()
```

```{r}
head(p91_imgt$tcrs) %>% 
    kable(format = "html")
```

---

## Constructing TCRs with MiXCR - selecting junctions 

```{r echo=TRUE, cache=FALSE}
p91_mixcr[["tcrs"]] <- p91_mixcr$jxns %>% 
    select_top_jxns() %>% 
    construct_tcrs()
```

```{r}
head(p91_mixcr$tcrs) %>% 
    kable(format = "html")
```

---

## Visualizing TCRs with Sankey diagrams

```{r echo=TRUE, cache=FALSE}
# setwd("/Users/jaeddy/code/github/presentations/labMtg_dec2015/")
# Combine IMGT and MiXCR TCRs
imgt_mixcr <- p91_imgt$tcrs %>% 
    mutate(tcr_source = "IMGT") %>% 
    bind_rows(p91_mixcr$tcrs %>% 
                  mutate(tcr_source = "MiXCR")) %>% 
    list(tcrs = .)

# Construct and display a sankey network linking libs to genes to junctions
imgt_mixcr[["plot"]] <- 
    build_sankey_network(imgt_mixcr$tcrs, 
                         chain = "both") %>% 
    build_sankey_plot(sankey_height = 550)
```

---

## Sankey again...

```{r results='asis', comment=NA, tidy=FALSE, cache=FALSE}
imgt_mixcr$plot$show('inline', include_assets = FALSE)
```

--- 

## B chain only

```{r, cache=FALSE}
# Construct and display a sankey network linking libs to genes to junctions
imgt_mixcr[["plot_b"]] <- 
    build_sankey_network(imgt_mixcr$tcrs, 
                         chain = "B") %>% 
    build_sankey_plot(sankey_height = 550)
```
 
```{r results='asis', comment=NA, tidy=FALSE, cache=FALSE}
imgt_mixcr$plot_b$show('inline', cdn = TRUE, include_assets = FALSE)
```

--- 

## Differences only

```{r, cache=FALSE}
imgt_mixcr_diff <- p91_imgt$tcrs %>% 
    anti_join(p91_mixcr$tcrs) %>% 
    mutate(tcr_source = "IMGT") %>% 
    bind_rows(p91_mixcr$tcrs %>%
                  anti_join(p91_imgt$tcrs) %>% 
                  mutate(tcr_source = "MiXCR")) %>% 
    list(tcrs = .)

imgt_mixcr_diff[["plot"]] <- 
    build_sankey_network(imgt_mixcr_diff$tcrs, 
                         chain = "B") %>% 
    build_sankey_plot(sankey_height = 550)
```

```{r results='asis', comment=NA, tidy=FALSE, cache=FALSE}
imgt_mixcr_diff$plot$show('inline', cdn = TRUE, include_assets = FALSE)
```

--- 

## MiXCR with Trinity

```{r, cache=FALSE}
mixcr_folder <- "data/P91_new/P91-11/mixcrOutput_trinity/"
project <- "P91-11"
out_folder <- mixcr_folder

# Combine MiXCR junctions into a single file; read, format, and filter junctions
p91_mixcr_trinity <- 
    combine_mixcr_outputs(mixcr_folder, out_folder, project) %>% 
    format_mixcr_jxns() %>% 
    filter_mixcr_jxns() %>% 
    list(jxns = .)
```

```{r echo=TRUE, cache=FALSE}
p91_mixcr_trinity[["tcrs"]] <- p91_mixcr_trinity$jxns %>% 
    select_top_jxns() %>% 
    construct_tcrs()
```

--- 

## How'd we do?

```{r, cache=FALSE}
# Combine IMGT and MiXCR TCRs
imgt_mixcr_trinity <- p91_imgt$tcrs %>% 
    mutate(tcr_source = "IMGT") %>% 
    bind_rows(p91_mixcr_trinity$tcrs %>% 
                  mutate(tcr_source = "MiXCR")) %>% 
    list(tcrs = .)

# Construct and display a sankey network linking libs to genes to junctions
imgt_mixcr_trinity[["plot_b"]] <- 
    build_sankey_network(imgt_mixcr_trinity$tcrs, 
                         chain = "B") %>% 
    build_sankey_plot(sankey_height = 550)
```

```{r results='asis', comment=NA, tidy=FALSE, cache=FALSE}
imgt_mixcr_trinity$plot_b$show('inline', cdn = TRUE, include_assets = FALSE)
```

--- 

## Checking all

```{r, cache=FALSE}
# Construct and display a sankey network linking libs to genes to junctions
imgt_mixcr_trinity[["plot"]] <- 
    build_sankey_network(imgt_mixcr_trinity$tcrs, 
                         chain = "both") %>% 
    build_sankey_plot(sankey_height = 550)
```

```{r results='asis', comment=NA, tidy=FALSE, cache=FALSE}
imgt_mixcr_trinity$plot$show('inline', cdn = TRUE, include_assets = FALSE)
```

---

## Case 3: P48

```{r, cache=FALSE}
project <- "P48"

mixcr_folder <- "data/P48/mixcrOutput_trimFq/"
out_folder <- dirname(summary_file)
        
# Combine MiXCR junctions into a single file; read, format, and filter junctions
p48_mixcr <- 
    combine_mixcr_outputs(mixcr_folder, out_folder, project) %>% 
    format_mixcr_jxns() %>% 
    filter_mixcr_jxns(min_count = 10) %>% 
    list(jxns = .)

mixcr_folder <- "data/P48/mixcrOutput_trinity/"
project <- "P48"
out_folder <- mixcr_folder

# Combine MiXCR junctions into a single file; read, format, and filter junctions
p48_mixcr_trinity <- 
    combine_mixcr_outputs(mixcr_folder, out_folder, project) %>% 
    format_mixcr_jxns() %>% 
    filter_mixcr_jxns() %>% 
    list(jxns = .)

p48_mixcr[["tcrs"]] <- p48_mixcr$jxns %>% 
    select_top_jxns() %>% 
    construct_tcrs()

p48_mixcr_trinity[["tcrs"]] <- p48_mixcr_trinity$jxns %>% 
    select_top_jxns() %>% 
    construct_tcrs()
```

```{r, cache=FALSE}
# Combine IMGT and MiXCR TCRs
mixcr_mixcr_trinity <- p48_mixcr$tcrs %>% 
    mutate(tcr_source = "IMGT") %>% 
    bind_rows(p48_mixcr_trinity$tcrs %>% 
                  mutate(tcr_source = "MiXCR")) %>% 
    list(tcrs = .)

# Construct and display a sankey network linking libs to genes to junctions
mixcr_mixcr_trinity[["plot"]] <- 
    build_sankey_network(mixcr_mixcr_trinity$tcrs, 
                         chain = "both") %>% 
    build_sankey_plot(sankey_height = 550)
```

```{r results='asis', comment=NA, tidy=FALSE, cache=FALSE}
mixcr_mixcr_trinity$plot$show('inline', cdn = TRUE, include_assets = FALSE)
```

--- 

## Allowing multiple TRAV

```{r, cache=FALSE}
p48_mixcr[["tcrs"]] <- p48_mixcr$jxns %>% 
    select_top_jxns(allow_multi = TRUE) %>% 
    construct_tcrs()

p48_mixcr_trinity[["tcrs"]] <- p48_mixcr_trinity$jxns %>% 
    select_top_jxns(allow_multi = TRUE) %>% 
    construct_tcrs()

# Combine IMGT and MiXCR TCRs
mixcr_mixcr_trinity <- p48_mixcr$tcrs %>% 
    mutate(tcr_source = "IMGT") %>% 
    bind_rows(p48_mixcr_trinity$tcrs %>% 
                  mutate(tcr_source = "MiXCR")) %>% 
    list(tcrs = .)

# Construct and display a sankey network linking libs to genes to junctions
mixcr_mixcr_trinity[["plot"]] <- 
    build_sankey_network(mixcr_mixcr_trinity$tcrs, 
                         chain = "both") %>% 
    build_sankey_plot(sankey_height = 550)
```

```{r results='asis', comment=NA, tidy=FALSE, cache=FALSE}
mixcr_mixcr_trinity$plot$show('inline', cdn = TRUE, include_assets = TRUE)
```

--- 

## Remaining questions

--- 

## VDJtools

--- 

## Acknowledgements 
